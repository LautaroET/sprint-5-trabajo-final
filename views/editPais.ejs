<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar País</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-100">
    <h1 class="text-3xl sm:text-4xl text-center py-6 font-semibold text-gray-800">Editar País</h1>

    <form class="max-w-md mx-auto p-6 bg-white rounded-md shadow-md" id="editarFormulario" data-id="<%= pais._id %>">
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name.common">Nombre País Común:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="name.common" id="name.common" value="<%= pais.name.common %>" minlength="3" maxlength="90" required>
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name.official">Nombre País Oficial:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="name.official" id="name.official" value="<%= pais.name.official %>" minlength="3" maxlength="90" required>
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="name.nativeName.spa.official">Nombre País Oficial (Español):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="name.nativeName.spa.official" id="name.nativeName.spa.official" value="<%= pais.name.nativeName.spa.official %>" minlength="3" maxlength="90" required>
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="capital">Capital(es):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="capital" id="capital" value="<%= pais.capital %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="borders">Fronteras (separadas por coma):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="borders" id="borders" value="<%= pais.borders %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="area">Área (km²):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" name="area" id="area" value="<%= pais.area %>" min="0">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="population">Población:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" name="population" id="population" value="<%= pais.population %>" min="0">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="region">Región:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="region" id="region" value="<%= pais.region %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="subregion">Sub Región:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="subregion" id="subregion" value="<%= pais.subregion %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="timezones">Zona Horaria:</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" name="timezones" id="timezones" value="<%= pais.timezones %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="flags.png">Bandera (URL):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="url" name="flags.png" id="flags.png" value="<%= pais.flags.png %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="maps.googleMaps">Mapa (URL):</label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="url" name="maps.googleMaps" id="maps.googleMaps" value="<%= pais.maps.googleMaps %>">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="gini">Índice GINI:</label>
            <div class="flex space-x-4">
                <input class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" name="gini_year" id="gini_year" placeholder="Año" min="1900" max="2099" value="<%= Object.keys(pais.gini)[0] %>">
                <input class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" name="gini_value" id="gini_value" placeholder="Índice" min="0" max="100" step="0.1" value="<%= Object.values(pais.gini)[0] %>">
            </div>
        </div>

        <button class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">Guardar Cambios</button>
    </form>
    <br>

    <script>
    document.getElementById('editarFormulario').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = {};

        formData.forEach((value, key) => {
            data[key] = value;
        });

        // Función para procesar arrays desde strings
        function processArrayField(fieldName) {
            if (typeof data[fieldName] === 'string') {
                data[fieldName] = data[fieldName].split(',').map(item => item.trim());
            }
        }

        processArrayField('capital');
        processArrayField('borders');
        processArrayField('timezones');

         // Agrega manejo para el GINI
        const giniYear = data.gini_year;
        const giniValue = data.gini_value;
        if (giniYear && giniValue) {
            data.gini = {
                [giniYear]: parseFloat(giniValue)
            };
        } else {
            delete data.gini; // Elimina la propiedad GINI si no se proporcionaron ambos valores
        }

        const id = form.getAttribute('data-id');

        try {
            const response = await fetch(`/api/pais/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.href = '/api/dashboard';
            } else {
                const errorData = await response.json();
                alert('Error al actualizar: ' + errorData.mensaje);
            }
        } catch (err) {
            console.error(err);
            alert('Error al conectar con el servidor');
        }
    });
    </script>
</body>
</html>

