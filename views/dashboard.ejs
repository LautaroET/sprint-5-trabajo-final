<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-300">
    <table class="w-full shadow-md rounded-lg overflow-hidden border border-collapse">
        <%-include('partials/header.ejs')%>
        <tbody>
<%
    let totalPoblacion = 0;
    let totalArea = 0;
    let totalGini = 0;
    let contadorGini = 0;
%>

<% paises.forEach(pais => { 
    totalPoblacion += pais.population || 0;
    totalArea += pais.area || 0;
    const valoresGini = pais.gini ? Object.values(pais.gini) : [];
    if (valoresGini.length > 0) {
        totalGini += valoresGini[0];
        contadorGini++;
    }
%>
<tr class="hover:bg-gray-50 border">
    <td class="p-5 text-1.5xl"><%= pais.name?.nativeName?.spa?.official || pais.name.official %></td>
    <td class="p-5 text-1.5xl"><%= pais.capital %></td>
    <td class="p-5 text-1.5xl"><%= pais.borders %></td>
    <td class="p-5 text-1.5xl"><%= pais.area %></td>
    <td class="p-5 text-1.5xl"><%= pais.population %></td>
    <td class="p-5 text-1.5xl"><%= pais.region %></td>
    <td class="p-5 text-1.5xl"><%= pais.subregion %></td>
    <td class="p-5 text-1.5xl"><%= pais.timezones.join(", ") %></td>
    <td class="p-3"><img src="<%= pais.flags.png %>" alt="pais.name.common" class="h-8"></td>
    <td class="p-5 text-2xl"><a href="<%= pais.maps.googleMaps%>">mapa</a></td>
    <td class="p-5 text-2xl"><%= pais.creador %></td>
    <td class="p-5"><a href="/api/pais/<%= pais.name.official %>/editar"><button class="cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded focus:outline-none focus:shadow-outline text-2xl">Editar</button></a></td>
    <td class="p-5">
    <button class="cursor-pointer bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded focus:outline-none focus:shadow-outline text-2xl"
        onclick="eliminarPais('<%= pais._id %>')">Eliminar</button>
    </td>
</tr>
<% }); %>

<tr class="bg-yellow-200 font-bold text-lg border-t-2 border-gray-700">
    <td colspan="3" class="p-5">Totales:</td>
    <td class="p-5"><%= totalArea.toLocaleString('es-ES') %> km²</td>
    <td class="p-5"><%= totalPoblacion.toLocaleString('es-ES') %> hab.</td>
    <td colspan="3"></td>
    <td colspan="2">GINI promedio:</td>
    <td class="p-5 text-center" colspan="3">
        <%= contadorGini > 0 ? (totalGini / contadorGini).toFixed(2) : "N/A" %>
    </td>
</tr>
</tbody>

    </table>
    <script>
/**
 * Elimina un país del sistema, confirmando la acción con el usuario y enviando una solicitud DELETE al servidor.
 * 
 * @param {string} nombreOficial - El nombre oficial del país que se desea eliminar.
 */
function eliminarPais(id) {
    // Se muestra una ventana de confirmación al usuario para asegurar que desea eliminar el país
    if (confirm('¿Está seguro de que desea eliminar este país?')) {
        
        // Se realiza la solicitud DELETE al servidor para eliminar el país indicado
        fetch(`/api/pais/${id}`, {
            method: 'DELETE' // Especificamos que la solicitud es de tipo DELETE
        })
        .then(res => {
            // Si la respuesta del servidor es exitosa (código 2xx), se muestra un mensaje de éxito
            if (res.ok) {
                alert('País eliminado correctamente');
                location.reload(); // Recarga la página para reflejar los cambios realizados
            } else {
                // Si la respuesta no es exitosa, se extrae el mensaje de error del cuerpo de la respuesta
                return res.json().then(data => {
                    // Lanza un error con el mensaje proporcionado por el servidor o un mensaje por defecto
                    throw new Error(data.mensaje || 'Error al eliminar');
                });
            }
        })
        .catch(err => {
            // Si ocurre algún error durante la solicitud o procesamiento de la respuesta, se muestra una alerta con el mensaje de error
            alert(`Error: ${err.message}`);
        });
    } else {
        // Si el usuario cancela la confirmación, se muestra un mensaje informando que la eliminación fue cancelada
        alert('La eliminación ha sido cancelada.');
    }
}

</script>

</body>
</html>